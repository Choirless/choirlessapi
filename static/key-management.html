<!DOCTYPE html>
<html lang="en">

    <head>
        <title>Choirless Key Management</title>

        <style>

            body{
                font-family: sans-serif;
                font-size: 14px;
            }

            table{
                border-collapse: collapse;
            }

            table thead{
                background-color: black;
                color: white;
                font-weight: 800;
            }

            table thead td{
                border: 1px solid white;
            }

            table td{
                border: 1px solid black;
                padding: 0.5em;
            }

        </style>

    </head>

    <body>

        <h1>Choirless Keys</h1>

        <h2>Existing Keys</h2>

        <table id="existing">

            <thead>
                <tr>
                    <td>Key Name</td>
                    <td>Key</td>
                    <td>Created By</td>
                    <td>Creation Date</td>
                    <td>Delete?</td>
                </tr>
            </thead>

            <tbody>

                <!--<tr>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>-->

            </tbody>

        </table>

        <h2>Create Key</h2>

        <form method="POST" action="/keys/create" id="create">

            <label>Key name</label>
            <input type="text" name="keyname" required/>

            <input type="submit" value="Create">

        </form>

    </body>

    <script>

        (function(){
            'use strict';

            var existingKeysTable = document.querySelector('table#existing');
            var existingKeysTableBody = existingKeysTable.querySelector('tbody');

            var createNewKeyForm = document.querySelector('form#create');

            fetch('/keys/list', {
                    credentials : 'include'
                })
                .then( function(response){
                    if(response.ok){
                        return response.json();
                    } else {
                        throw response;
                    }
                })
                .then(results => {
                    console.log(results);

                    var keyTableDocumentFragment = document.createDocumentFragment();

                    results.data.forEach(function(keyInfo){

                        var row = document.createElement('tr');

                        var name = document.createElement('td');
                        var key = document.createElement('td');
                        var createdBy = document.createElement('td');
                        var creationDate = document.createElement('td');
                        var deleteKeyHolder = document.createElement('td');
                        var deleteKeyAction = document.createElement('a');

                        name.textContent = keyInfo.name;
                        key.textContent = keyInfo._id;
                        createdBy.textContent = keyInfo.owner;
                        creationDate.textContent = new Date(keyInfo.created);

                        deleteKeyAction.href = "#"
                        deleteKeyAction.dataset.key = keyInfo._id;
                        deleteKeyAction.textContent = "Delete";

                        deleteKeyAction.addEventListener('click', function(e){
                            e.preventDefault();
                            e.stopImmediatePropagation();

                            console.log(this.dataset.key);

                            fetch('/keys/delete', {
                                    method : "POST",
                                    credentials : "include",
                                    headers : {
                                        "Content-Type" : "application/json"
                                    },
                                    body : JSON.stringify({
                                        key : this.dataset.key
                                    })
                                })
                                .then(function(response){
                                    if(response.ok){
                                        window.location.reload();
                                    } else {
                                        throw response
                                    }
                                })
                                .catch(function(err){
                                    console.log(err);
                                })
                            ;

                        }, false);

                        deleteKeyHolder.appendChild(deleteKeyAction);

                        row.appendChild(name);
                        row.appendChild(key);
                        row.appendChild(createdBy);
                        row.appendChild(creationDate);
                        row.appendChild(deleteKeyHolder);

                        keyTableDocumentFragment.appendChild(row)

                    });

                    existingKeysTableBody.appendChild(keyTableDocumentFragment);

                })
                .catch(function(err){
                    console.log(err);
                })
            ;

            createNewKeyForm.addEventListener('submit', function(e){
                e.preventDefault();
                e.stopImmediatePropagation();

                var keyname = this[0].value;

                fetch('/keys/create', {
                        method : "POST",
                        credentials : "include",
                        headers : {
                            "Content-Type" : "application/json"
                        },
                        body : JSON.stringify( { keyname : keyname } ),
                    })
                    .then(function(res){
                        if(res.ok){
                            window.location.reload();
                        } else {
                            throw res;
                        }
                    })
                    .catch(function(err){
                        console.log(err);
                    })
                ;

            }, false);

        }());

    </script>

</html>